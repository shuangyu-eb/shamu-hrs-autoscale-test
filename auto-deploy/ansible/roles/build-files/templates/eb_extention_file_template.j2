files:
  "/tmp/consul_installation.sh" :
    mode: "000755"
    owner: root
    group: root
    content: |
      #! /bin/bash
      yum -y install wget unzip
      wget https://releases.hashicorp.com/consul/1.4.2/consul_1.4.2_linux_amd64.zip
      mkdir consul
      unzip consul_1.4.2_linux_amd64.zip -d consul
      mv consul/consul /usr/bin/
      rm consul_1.4.2_linux_amd64.zip
      rm -R consul/
      BIND_IP=`curl http://169.254.169.254/latest/meta-data/local-ipv4`
      nohup consul agent -retry-join=" provider=aws tag_key=aws:cloudformation:stack-name tag_value={{ stack_prefix }}-{{ env }}-consul-cluster region={{ region }} access_key_id={{ aws_deploy_access_key }} secret_access_key={{ aws_deploy_secret_key }}" -bind=${BIND_IP} -data-dir=~/data -ui > log.txt &
      exit;

commands:
  consul_install:
    command: "sh /tmp/consul_installation.sh"
    ignoreErrors: false